---
title: "Hate Speech Detection"
output: html_notebook
---

## Load Datasets
```{r}
train <- read.csv("./Data/train.csv")
test <- read.csv("./Data/test.csv")

x_train <- train$tweet
y_train <- train$label
x_test <- test$tweet
y_test <- test$tweet
cat('Train set size: ', length(x_train), '\n')
cat('Test set size: ', length(y_test), '\n')
```

## Check and clean text data
```{r}
cat("Cleaning training sample tweets\n")
x_train <- clean_data(x_train)
cat("\nCleaning test sample tweets\n")
x_test <- clean_data(x_test)
```
## Trining set class balancing
If fit this data to train the hate speech detection model, then the model will not generalize any hate speech because the data with context to the hate speech is very less than the positive ones. We use the oversampling technique to balance classes that repeatedly samples, with replacement, from the minority class until the class is the same size as the majority. 
```{r}
cat('Training set class 1 size: ',length(x_train[y_train == 1]), '\n') #2242
cat('Training set class 0 size: ',length(x_train[y_train == 0]), '\n\n') #29720

cat('Balancing classes...\n')
x_train_0 <- x_train[x_test == 0]
x_train_1 <- x_train[x_test == 1]
x_train_1_oversampled <- sample(x = x_train_1, size = length(x_train_0), replace = TRUE)
x_train_oversampled <- c(x_train_0,x_train_1_oversampled)
cat('Done.\n\n')

cat('Training set class 1 size: ',length(x_train[y_train == 1]), '\n') #2242
cat('Training set class 0 size: ',length(x_train[y_train == 0]), '\n\n') #29720

```


## Functions
```{r}
library(utf8)

clean_data <- function(data){
  cat("--> Transforming text to lower case...\n")
  data <- tolower(data)
  cat("--> Done.\n")
  cat("--> Checking utf8 encoding and NFC...\n")
  basic_check(data)
  cat("--> Removing unwanted words and/or characters...\n")
  data <- remove_unwanted_ch_nl_and_spaces(data)
  cat("--> Done.\n")
  
  return(data)
}

remove_unwanted_ch_nl_and_spaces <- function(data){
  
  data_wo_unwanted_ch <- gsub("(@[A-Za-z0-9]+)|([^0-9A-Za-z \\t])|(\\w+:\\/\\/\\S+)|^rt|http.+?", " ",data)
  ## Remove \n from the text  
  data_wo_nl <- gsub("[\n]{1,}", " ", data_wo_unwanted_ch)
  ## remove sequences of more than one space
  data <- gsub("[ ]{2,}"," ",data_wo_nl)
  return(data)
  
}

basic_check <- function(data){
  # Check encoding
  test1 <- data[!utf8_valid(data)]
  
  #Check character normalization. Specifically, the normalized composed form (NFC)
  data_q_nfc <- utf8_normalize(data)
  test2 <- sum(data_q_nfc != data)
  
  if (identical(test1, character(0)) && test2 == 0){
    cat("--> Encoding and NFC check passed.\n")
  }
  else{
    cat("--> Error: Check not passed\nEncoding result: ",test1,"\nCharacter normalization result: ",test2, "\n")
  }
}
```

